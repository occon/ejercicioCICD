name: ğŸš€ Deploy
on: 
    push:
        branches:
          - main
          - dev
    pull_request:
    
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

permissions:
    actions: write
    contents: read

jobs: 
    lint:
        name: â¬£ ESLint 
        runs-on: ubuntu-latest 
        steps:
          - name: â¬‡ï¸ Checkout repo 
            uses: actions/checkout@v3

          - name: â” Setup node
            uses: actions/setup-node@v3 
            with:
                cache: npm
                cache-dependency-path: ./package.json
                node-version: 18

          - name: ğŸ“¥ Install deps 
            run: npm install

          - name: ğŸ”¬ Lint 
            run: npm run lint

    typecheck:
        name: Ê¦ TypeScript 
        runs-on: ubuntu-latest 
        steps:
          - name: â¬‡ï¸ Checkout repo 
            uses: actions/checkout@v3

          - name: â” Setup node
            uses: actions/setup-node@v3 
            with:
                cache: npm
                cache-dependency-path: ./package.json
                node-version: 18

          - name: ğŸ“¥ Install deps 
            run: npm install
            
          - name: ğŸ” Type check
            run: npm run typecheck --if-present

    vitest:
        name: âš¡ Vitest 
        runs-on: ubuntu-latest 
        steps:
          - name: â¬‡ï¸ Checkout repo 
            uses: actions/checkout@v3

          - name: â” Setup node
            uses: actions/setup-node@v3 
            with:
                cache: npm
                cache-dependency-path: ./package.json
                node-version: 18

          - name: ğŸ“¥ Install deps 
            run: npm install
            
          - name: âš¡ Run vitest
            run: npm run test -- --coverage

    cypress:
        name: âš« Cypress 
        runs-on: ubuntu-latest 
        steps:
          - name: â¬‡ï¸ Checkout repo 
            uses: actions/checkout@v3

        #   - name: ğŸ„â€â™‚ï¸ Copy test env vars
        #     run:
        #         cp .env.example .env

          - name: Setup .env
            uses: appleboy/ssh-action@master
            env: 
                DATABASE_URL: "postgres://${{ secrets.PSQL_USER }}:${{ secrets.PSQL_PWD }}@localhost:5432/${{ secrets.PSQL_DB }}"
                SESSION_SECRET: "${{ secrets.SESSION_SECRET }}"
            with:
                envs: DATABASE_URL,SESSION_SECRET
                script: |
                    echo DATABASE_URL="$DATABASE_URL" >> .env
                    echo SESSION_SECRET="$SESSION_SECRET" >> .env

          - name: â” Setup node
            uses: actions/setup-node@v3 
            with:
                cache: npm
                cache-dependency-path: ./package.json
                node-version: 18

          - name: Setup database
            uses: harmon758/postgresql-action@v1
            with:
                postgresql version: "12"
                postgresql db: ${{ secrets.PSQL_DB }}
                postgresql user: ${{ secrets.PSQL_USER }}
                postgresql password: ${{ secrets.PSQL_PWD }}

          - name: ğŸ“¥ Install deps 
            run: npm install
            
          - name: ğŸ› ï¸ Build Database
            run: npx prisma migrate reset --force

          - name: âš™ï¸ Build 
            run: npm run build

          - name: Cypress run
            uses: cypress-io/github-action@v5 
            with:
                start: npm run start:mocks
                wait-on: http://localhost:8811
            env:
                PORT: 8811                